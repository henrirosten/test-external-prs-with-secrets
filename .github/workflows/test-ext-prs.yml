name: test-ext-prs

on:
  pull_request_target:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  authorize-build:
    environment:
      ${{ github.event_name == 'pull_request_target' &&
      github.event.pull_request.head.repo.full_name != github.repository && 'external' || 'internal' }}
    runs-on: ubuntu-latest
    steps:
      - run: true

  check-workflow-changes:
    needs: authorize-build
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check-workflow.outputs.workflow_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
      - name: Check if this workflow file is modified
        id: check-workflow
        shell: bash
        run: |
          echo "git log -1 --pretty=oneline:"
          git log -1 --pretty=oneline

          echo "git diff --name-only HEAD^ HEAD:"
          git diff --name-only HEAD^ HEAD

          echo "Checking if workflow file is modified"
          workflow_changed='False'
          while read -r line;
          do
            if [[ ${{ github.workflow_ref }} == *$line* ]]; then
              echo "Change modifies this workflow file"
              workflow_changed='True'
            fi
          done < <(git diff --name-only HEAD^ HEAD)
          echo "workflow_changed=$workflow_changed"
          echo "workflow_changed=$workflow_changed" >> "$GITHUB_OUTPUT"
          if [ "$workflow_changed" = "False" ]; then
            exit 0
          fi

          echo "github.event_name: ${{ github.event_name }}"
          echo "github.repository: ${{ github.repository }}"
          echo "github.event.pull_request.head.repo.full_name: ${{ github.event.pull_request.head.repo.full_name }}"
          if [ ${{ github.event_name }} = 'pull_request_target' ] && \
             [ ${{ github.event.pull_request.head.repo.full_name }} != ${{ github.repository }} ];
          then
            echo ""
            echo "::error::Editing this workflow file from an external PR is not allowed."
            exit 1
          fi
          echo ""
          echo "::error::"\
               "Editing this workflow file from an internal PR is allowed. However,"\
               "note the following: the change you have done for this workflow will"\
               "only take impact after merge."\
               "Therefore, you need to manually test this change (perhaps in a"\
               "forked repo) before merge to make sure the change does not break"\
               "anything."\
               "For now, there's no point of running the remaining steps since the"\
               "results would not reflect the change you have done to the workflow"\
               "file, and might cause outright confusion or misinterpretation."
  build:
    needs: 
      - authorize-build
      - check-workflow-changes
    runs-on: ubuntu-latest
    # Only run the build steps if the change does not modify this workflow file,
    # as explained in the error message in the check-workflow step.
    if: needs.check-workflow-changes.outputs.changed == 'False'
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
      - name: Print REPO_SECRET
        run: printenv REPO_SECRET 
        env:
          REPO_SECRET: ${{ secrets.REPO_SECRET }}
